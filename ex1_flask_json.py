from joblib import dump, load
from flask import Flask
from flask import request
import pandas as pd
import time
import json
import os

app = Flask(__name__)

# /predict_single/?pixels=0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,224,223,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,29,230,229,28,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,252,118,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,252,118,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,252,118,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,248,104,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,238,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,166,252,223,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,252,222,0,0,0,27,46,168,185,45,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,252,222,0,0,27,209,253,252,252,252,177,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,253,253,223,0,38,219,253,255,253,253,253,253,135,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,252,222,0,90,252,252,253,252,252,252,252,222,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,252,222,0,186,252,252,253,252,252,252,252,222,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,252,252,222,0,238,252,252,253,252,252,252,252,236,56,0,0,0,0,0,0,0,0,0,0,0,0,0,2,134,252,248,223,250,252,252,253,252,252,252,252,225,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,106,248,252,252,252,252,252,253,252,252,252,252,204,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,223,252,252,252,252,252,253,252,252,252,212,35,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,223,252,252,252,252,252,253,252,252,252,177,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,52,195,252,252,252,252,253,252,214,59,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,74,182,252,252,252,253,128,36,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

@app.route('/predict_single/')
def predict_single():
    """Predict an element"""
    clf_load = load('model.joblib')
    before_time = time.time()
    pixels = request.args.get('pixels')
    sample_test = pd.DataFrame([pixels.split(',')])
    y_pred = clf_load.predict(sample_test)
    print('\nPrediction is ' + y_pred[0] + ', found in ' + str(round(time.time() - before_time, 3)) + ' seconds')
    return ('Prediction is ' + y_pred[0] + ', found in ' + str(round(time.time() - before_time, 3)) + ' seconds')


@app.route('/predict/', methods=['POST'])
def predict():
    """Predict an element"""
    clf_load = load('model.joblib')
    json_data = request.get_json(force=True)
    dict_sample = json.loads(json_data)
    df_samples = pd.DataFrame.from_dict(dict_sample, orient="index")
    y_pred = clf_load.predict(df_samples)
    return str(y_pred)


if __name__ == '__main__':
    port = os.environ.get('PORT')
    if port:
        app.run(host = '0.0.0.0', port=int(port))
    else:
        app.run()
    app.run()
